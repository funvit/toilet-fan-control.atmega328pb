# Управление вытяжкой на Atmel Nano Pro

После поломки аналогового блока управления вытяжкой я решил соорудить замену.

Поскольку я лучше разбираюсь в программировании, чем в теории цепей – было решено использовать микроконтроллер.

Mega328PB в исполнении платы с usb-разъемом (для программирования) я выбрал по качествам:

- минимальный размер
- простота "прошивания"
- дешевизна
- наличие примеров кода



## Основные компоненты

- микроконтроллер Iskra Nano Pro на базе ATmega328PB (исполнение на плате) "Amperka.ru" (16 МГц, 5 В)
- датчик освещенности - фоторезистор GL5528 (в исполнении Troyka-Light Sensor)
- 4 микрокнопки
- Транзистор BC546BTA NPN
- реле электромагнитное NRP05-A-05D "NCR" (1 зам. 5V / 5A, 250VAC)
- [OLED экран 0.96inch на чипе SSD1306 "Waveshare Electronics"](https://www.waveshare.com/0.96inch-oled-b.htm) 128x64px (spi/i2c, 2 зоны цвета) 
- блок питания готовый PS-05-5 "MEAN WELL" (5В, 1А, 5Вт)

Использование экрана приводит к удорожанию изделия, но простота в использовании (конфигурирование) конечного устройства перебивает жадность :-)



## Заметки по коду

Для работы с дисплеем используется патченная мной версия библиотеки TroykaOLED (by Igor Dementiev).

1. Библиотека очень простая. Позволяет выводить и текст и графику.
2. Было изменено:
   - русский шрифт 6x8
   - добавлена функция вывода текста с переносом строки (printWrapping)

В проекте используется сторожевой таймер на 2 секунды. Т.е. если микроконтроллер зависнет - он автоматически перезапустится.

_Косвенно это позволит судить об критичной ошибке в коде, если устройство работает по 2 секунды и перезапускается постоянно..._



## Сборка

### Заметки о компонентах

- У OLED-модуля переключен режим на **i2c** путем перепайки перемычки BS1 в положение "1". После этого пин DIN становится *SDA*, а CLK - *SCL*.
- Так же у модуля есть пин RESET. Это учитывается в коде (при включении и сбросе устройства - посылается сигнал).
- 4 кнопки подключены по схеме "*матрица*", для упрощения работы из кода.
- LED1 служит для индикации работы реле.

<details><summary>Фото дисплея</summary>

![Вид спереди](/docs/oled-1.png)

![Вид сзади](/docs/oled-1-back.png)

</details>



### Схема

<details><summary>Принципиальная</summary>

![Схема](/docs/schema.png)

</details>

<details><summary>Вариант на макетке</summary> 

![Макетка](/docs/bread-board.png)

</details>



## Работа с устройством

После включения дисплей моргает всеми пикселами. Так сделано что бы понимать, что он жив.

Далее отображается страница "интро". На ней выводится название устройства, версия прошивки и github-адрес проекта.

Эта страница отображается несколько секунд, после чего происхдит переход на основную страницу.

"Интро"-страницу можно быстро пропустить нажатием на "Ок".

![Intro page](/docs/intro-page.png)

На основной странице доступен переход в меню управления настройками по кнопке "Меню".

> Важно: в версии 0.5.0 имзенен UI!
> Скриншотов пока нет...
>
> TODO: обновить скриншоты.

### Основная страница

![Default page - waiting](/docs/default-page-waiting.png)

Здесь отображается:

1. Небольшой график от сенсора освещенности.
2. Текущее и пороговое значения освещенности.
3. Состояние вытяжного вентилятора (графическое изображение; значение таймера(ов)).
4. Uptime (время работы без сбоя). Используется реализация с подсчетом дней и поддерживается более 50 дней (обход ограничения встроенного счетчика микроконтроллера).



### Страница меню

![Menu page](/docs/menu-page.png)

Доступно для изменения 3 параметра:

1. Задержка перед включением реле при превышении порогового значения освещенности.
2. Продолжительность замкнутого состояния реле после выключения света в помещении.
3. Пороговое значение освещенности.

Для выбора параметра используются кнопки "+" и "-" как "вверх" и "вниз". Далее необходимо нажать "Ок".
Происходит переход в состояние изменения значения параметра.

![Menu page - changing value](/docs/menu-page-changing-value.png)

Сохранение нового значения - кнопкой "Ок".

![Menu page - changed value saved](/docs/menu-page-changed-value-saved.png)

Отмена сохранения - кнопкой "Меню".

При длительном бездействии происходит выход со страницы.

![Menu page - auto exit](/docs/menu-page-auto-exit.png)



### Алгоритм работы

При превышении порогового значения запускается 1 таймер.

![Default page - delay](/docs/default-page-fan-delay.png)

Если в конце 1 таймера сенсор не будет по-прежнему фиксировать превышение порогового значения - реле не будет включено, и происходит возврат в режим ожидания.

_Это сделано для ситуации а-ля "быстро заглянули проверить"._

Иначе происходит переход в режим вентилирования.

![Default page - working](/docs/default-page-fan-on.png)

_Изменен алгоритм_ - и теперь, при наличии освещения, не запускается таймер 2. А просто происходит постоянное вентилирование.

Выключение света запускает таймер 2. При этом отображается его оставшееся кол-во секунд.

![Default page - working with delay 2](/docs/default-page-fan-on-delay-before-off.png)

В конце 2 таймера при наличии превышения порогового значения происходит переход в режим постоянной вентиляции (повтор). 

Иначе происходит выключение вытяжки.



# История изменений

1. Правка в схеме: добавлен резистор на 22ком для транзистора чтобы уменьшить влияние наводок. 

   При переносе на печатную плату заметил, что реле некоторое время остается в закрытом (активном) состоянии после пропадания питания на базе транзистора. 

   Виной оказался флюс на плате (получалось что то вкроде конденсатора). 

   Пришлось добавить резистор для "подтягивания" бызы транзистора на землю.

2. Изменение алгоритма работы таймера 2 (v0.2). Теперь таймер 2 запускается только 
   просле пропадания освещения. А при наличии освещения - реле замкнуто постоянно.

3. Добавлен sceen-saver, пока только базовый функционал (v0.3).

   Через n секунд (см `#define SCREENSAVER`) экран очищается, и периодически выводится надпись "режим сна экрана".

# Лицензия

UNLICENSE

То есть вы можете использовать этот проект как угодно. Однако я снимаю с себя какую либо ответственность!
